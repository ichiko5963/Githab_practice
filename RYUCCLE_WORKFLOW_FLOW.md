# Ryucle リマインダーボット 動作フロー

## 1. 全体フロー

```
GitHub Actions (5分ごと)
    ↓
Slack API ポーリング
    ↓
@Ryucleメンション検出
    ↓
AI解析 (OpenAI GPT-3.5-turbo)
    ↓
締切日抽出・リマインダー時刻計算
    ↓
ユーザー確認メッセージ送信
    ↓
ユーザー返答待機
    ↓
承認/キャンセル処理
    ↓
リマインダースケジュール
    ↓
指定時刻にリマインダー実行
```

## 2. 詳細フロー

### 2.1 メイン実行フロー

```
1. 起動
   ├─ 環境変数チェック
   ├─ 処理済みメッセージ読み込み
   └─ Slack API で全チャンネル取得

2. メンション検出
   ├─ 各チャンネルの過去1時間のメッセージを取得
   ├─ @Ryucleメンションを検出
   └─ 処理済みメッセージと照合

3. メッセージ処理
   ├─ AI による締切日抽出
   ├─ リマインダー時刻計算
   └─ ユーザー確認メッセージ送信

4. 確認処理
   ├─ ユーザーの返答を待機
   ├─ 承認/キャンセル処理
   └─ リマインダースケジュール

5. 終了
   ├─ 処理済みメッセージ保存
   └─ プロセス終了
```

### 2.2 AI解析フロー

```
ユーザーメッセージ
    ↓
OpenAI API 呼び出し
    ↓
JSON形式で解析結果取得
    ↓
締切日時・タスク内容・相対日数抽出
    ↓
リマインダー時刻計算
    ↓
利用可能なリマインダー一覧作成
```

### 2.3 ユーザー確認フロー

```
AI解析結果
    ↓
確認メッセージ送信
    ↓
ユーザー返答待機
    ↓
返答内容判定
    ├─ 「はい」「OK」「設定」 → 承認処理
    ├─ 「@Ryucle キャンセル」 → キャンセル処理
    └─ その他 → エラーメッセージ
    ↓
リマインダースケジュール
    ↓
設定完了メッセージ送信
```

### 2.4 リマインダー実行フロー

```
締切日時
    ↓
リマインダー時刻計算
    ├─ 3日前
    ├─ 1日前
    └─ 12時間前
    ↓
過去時刻除外
    ↓
setTimeout でスケジュール
    ↓
指定時刻にリマインダーメッセージ送信
```

## 3. エラーハンドリングフロー

### 3.1 環境変数エラー
```
環境変数チェック
    ↓
未設定項目検出
    ↓
エラーメッセージ出力
    ↓
プロセス終了
```

### 3.2 AI解析エラー
```
OpenAI API 呼び出し
    ↓
エラー発生
    ↓
エラーログ出力
    ↓
フォールバック処理
    ↓
エラーメッセージ送信
```

### 3.3 Slack API エラー
```
Slack API 呼び出し
    ↓
エラー発生
    ↓
エラーログ出力
    ↓
次のチャンネル処理へ
    ↓
継続実行
```

## 4. データフロー

### 4.1 メッセージデータ
```
Slackメッセージ
    ↓
メッセージID抽出
    ↓
処理済みメッセージセットに追加
    ↓
JSONファイルに保存
```

### 4.2 リマインダーデータ
```
リマインダー情報
    ↓
確認待ちMapに保存
    ↓
承認後
    ↓
スケジュール済みMapに保存
    ↓
setTimeout ID管理
```

### 4.3 状態管理
```
起動時
    ↓
処理済みメッセージ読み込み
    ↓
実行中
    ↓
新規メッセージ処理
    ↓
終了時
    ↓
処理済みメッセージ保存
```

## 5. タイミングフロー

### 5.1 実行タイミング
```
GitHub Actions
    ↓
5分ごとの自動実行
    ↓
手動実行も可能
    ↓
実行時間: 約1-2分
    ↓
終了
```

### 5.2 リマインダータイミング
```
締切日時
    ↓
3日前: 締切日時 - 3日
    ↓
1日前: 締切日時 - 1日
    ↓
12時間前: 締切日時 - 12時間
    ↓
現在時刻より過去のものは除外
    ↓
利用可能なリマインダーのみスケジュール
```

## 6. メッセージフロー

### 6.1 メンション検出
```
ユーザー: @Ryucle 会議の準備 来週の金曜日
    ↓
Slack API でメッセージ取得
    ↓
@Ryucleメンション検出
    ↓
処理済みメッセージと照合
    ↓
新規メッセージとして処理
```

### 6.2 確認メッセージ
```
ボット: リマインダー設定の確認
    ├─ タスク: 会議の準備
    ├─ 締切: 2025-09-26 23:59:59
    └─ リマインダー: 3日前・1日前・12時間前
    ↓
ユーザー返答待機
```

### 6.3 承認処理
```
ユーザー: はい
    ↓
リマインダースケジュール
    ↓
ボット: リマインダー設定完了！
    ↓
指定時刻にリマインダー実行
```

## 7. エラー処理フロー

### 7.1 締切日が近すぎる場合
```
AI解析結果
    ↓
締切日時計算
    ↓
リマインダー時刻計算
    ↓
全て過去時刻
    ↓
エラーメッセージ送信
    ↓
処理終了
```

### 7.2 確認待ちリマインダーなし
```
ユーザー: はい
    ↓
確認待ちリマインダー検索
    ↓
見つからない
    ↓
エラーメッセージ送信
    ↓
処理終了
```

### 7.3 キャンセル処理
```
ユーザー: @Ryucle キャンセル
    ↓
確認待ちリマインダー検索
    ↓
該当リマインダー削除
    ↓
キャンセル完了メッセージ送信
    ↓
処理終了
```

## 8. パフォーマンスフロー

### 8.1 実行時間最適化
```
起動
    ↓
並列処理
    ├─ チャンネル取得
    ├─ メッセージ取得
    └─ メンション検出
    ↓
バッチ処理
    ↓
終了
```

### 8.2 メモリ使用量最適化
```
起動時
    ↓
必要最小限のデータ読み込み
    ↓
実行中
    ↓
不要データの削除
    ↓
終了時
    ↓
メモリクリーンアップ
```

## 9. セキュリティフロー

### 9.1 認証・認可
```
GitHub Actions
    ↓
環境変数読み込み
    ↓
Slack API 認証
    ↓
OpenAI API 認証
    ↓
API 呼び出し
```

### 9.2 データ保護
```
機密情報
    ↓
環境変数で管理
    ↓
ログ出力時はマスク
    ↓
一時ファイルに保存
    ↓
実行終了時に削除
```

## 10. 監視・ログフロー

### 10.1 ログ出力
```
各処理ステップ
    ↓
詳細ログ出力
    ↓
エラー発生時
    ↓
エラーログ出力
    ↓
GitHub Actions ログに記録
```

### 10.2 監視
```
実行開始
    ↓
処理状況ログ
    ↓
実行終了
    ↓
結果ログ
    ↓
次回実行まで待機
```
