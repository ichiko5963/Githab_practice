# Ryucle リマインダーボット 要件定義書

## 1. 概要
@Ryucleメンション時にAIを使って締切日を抽出し、ユーザー確認フローを経てリマインダーを設定するSlackボット

## 2. 基本要件

### 2.1 トリガー条件
- **対象**: 全チャンネル
- **条件**: @Ryucleメンション
- **実行方式**: GitHub Actions による5分ごとのポーリング実行
- **手動実行**: 可能（workflow_dispatch）

### 2.2 環境変数
- `SLACK_BOT_TOKEN`: Slackボットトークン
- `OPENAI_API_KEY`: OpenAI APIキー
- `TZ`: Asia/Tokyo

## 3. 機能要件

### 3.1 AIによる締切日抽出
- **AIエンジン**: OpenAI GPT-3.5-turbo
- **入力**: ユーザーの自然言語メッセージ
- **出力**: JSON形式
  ```json
  {
    "task": "タスク内容",
    "deadline": "YYYY-MM-DD HH:MM:SS形式の締切日時",
    "relativeDays": 数値（現在から何日後か）
  }
  ```
- **現在日時基準**: 2025年9月23日
- **デフォルト時刻**: 23:59:59（時刻未指定時）

### 3.2 リマインダー時刻計算
- **基本リマインダー**: 3日前、1日前、12時間前
- **計算基準**: 締切日時から逆算
- **過去時刻除外**: 現在時刻より過去のリマインダーは除外
- **利用可能数**: 1〜3個（締切日による）

### 3.3 ユーザー確認フロー
1. **AI解析結果表示**
   - タスク内容
   - 締切日時
   - 利用可能なリマインダー一覧（時刻付き）

2. **確認メッセージ**
   ```
   これで設定しますか？
   ✅ 設定する場合は「はい」または「OK」
   ❌ 変更する場合は「@Ryucle キャンセル」と言ってから再投稿
   ```

3. **承認処理**
   - 「はい」「OK」「設定」で承認
   - リマインダーをスケジュール
   - 設定完了メッセージを送信

### 3.4 キャンセル機能
- **トリガー**: 「@Ryucle キャンセル」
- **対象**: 確認待ちのリマインダー
- **処理**: 該当ユーザーの確認待ちリマインダーを削除
- **返答**: キャンセル完了メッセージ

### 3.5 リマインダー実行
- **実行方式**: setTimeoutによるスケジュール
- **メッセージ形式**: 
  ```
  🔔 **リマインダー**
  
  [タスク内容]
  
  *[3日前/1日前/12時間前]のリマインダーです*
  ```
- **投稿先**: 元のチャンネル（新しいメッセージとして）

## 4. 技術要件

### 4.1 アーキテクチャ
- **実行環境**: GitHub Actions (Ubuntu 24.04)
- **Node.js**: v20
- **実行方式**: ポーリング（5分間隔）
- **データ保存**: メモリ + 一時ファイル

### 4.2 データ管理
- **処理済みメッセージ**: Set + JSONファイル
- **確認待ちリマインダー**: Map
- **スケジュール済みリマインダー**: Map + setTimeout ID

### 4.3 エラーハンドリング
- **環境変数チェック**: 必須項目の存在確認
- **API エラー**: OpenAI API エラー時のフォールバック
- **Slack API エラー**: チャンネルアクセスエラーの処理
- **構文エラー**: JSON パースエラーの処理

## 5. 動作フロー

### 5.1 メイン実行フロー
1. **起動**
   - 環境変数チェック
   - 処理済みメッセージ読み込み
   - Slack API で全チャンネル取得

2. **メンション検出**
   - 各チャンネルの過去1時間のメッセージを取得
   - @Ryucleメンションを検出
   - 処理済みメッセージと照合

3. **メッセージ処理**
   - AI による締切日抽出
   - リマインダー時刻計算
   - ユーザー確認メッセージ送信

4. **確認処理**
   - ユーザーの返答を待機
   - 承認/キャンセル処理
   - リマインダースケジュール

5. **終了**
   - 処理済みメッセージ保存
   - プロセス終了

### 5.2 リマインダー実行フロー
1. **スケジュール**
   - 締切日時から逆算してリマインダー時刻を計算
   - setTimeout でスケジュール
   - タイムアウト ID を保存

2. **実行**
   - 指定時刻にリマインダーメッセージ送信
   - ログ出力
   - エラーハンドリング

## 6. メッセージ仕様

### 6.1 リマインダー設定確認
```
リュウクル参上だぞ🐲🔥

✅ **リマインダー設定の確認**

📝 タスク: [タスク内容]
📅 締切: [締切日時]
🔔 リマインダー:
• 3日前: [時刻]
• 1日前: [時刻]
• 12時間前: [時刻]

**これで設定しますか？**

✅ 設定する場合は「はい」または「OK」
❌ 変更する場合は「@Ryucle キャンセル」と言ってから再投稿してくれよな🔥
```

### 6.2 設定完了
```
リュウクル参上だぞ🐲🔥

✅ **リマインダー設定完了！**

📝 タスク: [タスク内容]
📅 締切: [締切日時]
🔔 リマインダー:
• 3日前: [時刻]
• 1日前: [時刻]
• 12時間前: [時刻]

オイラがちゃんと覚えておくから任せろだぞ🔥
忘れたらドラゴンの名折れだからな！
```

### 6.3 エラーメッセージ
- **締切日が近すぎる場合**
- **AI解析エラー**
- **確認待ちリマインダーなし**
- **キャンセル完了**

## 7. 品質要件

### 7.1 パフォーマンス
- **実行間隔**: 5分
- **応答時間**: 5分以内
- **メモリ使用量**: 最小限

### 7.2 信頼性
- **重複処理防止**: 処理済みメッセージ管理
- **エラー復旧**: 適切なエラーハンドリング
- **データ永続化**: 一時ファイルによる状態保存

### 7.3 セキュリティ
- **環境変数**: GitHub Secrets による管理
- **API キー**: 適切な権限設定
- **ログ**: 機密情報の非表示

## 8. 制約事項

### 8.1 技術制約
- **実行時間**: GitHub Actions の制限（6時間）
- **メモリ**: 一時的なデータ保存のみ
- **ネットワーク**: Slack API と OpenAI API へのアクセス

### 8.2 機能制約
- **チャンネル**: ボットがアクセス可能なチャンネルのみ
- **メッセージ**: 過去1時間以内のメッセージのみ
- **リマインダー**: 最大3個まで

## 9. テスト要件

### 9.1 単体テスト
- AI 解析機能
- リマインダー時刻計算
- メッセージ処理

### 9.2 統合テスト
- Slack API 連携
- OpenAI API 連携
- エンドツーエンドフロー

### 9.3 負荷テスト
- 大量メッセージ処理
- 同時実行
- メモリ使用量

## 10. 運用要件

### 10.1 監視
- **ログ**: 詳細な実行ログ
- **エラー**: エラー発生時の通知
- **パフォーマンス**: 実行時間の監視

### 10.2 メンテナンス
- **定期実行**: 5分ごとの自動実行
- **手動実行**: 必要時の手動実行
- **ログローテーション**: 適切なログ管理

### 10.3 バックアップ
- **設定**: GitHub Secrets による管理
- **コード**: Git によるバージョン管理
- **データ**: 一時的なデータのみ

## 11. 将来拡張

### 11.1 機能拡張
- **データベース**: 永続的なデータ保存
- **通知**: メール通知機能
- **カレンダー**: 外部カレンダー連携

### 11.2 パフォーマンス改善
- **並列処理**: 複数チャンネルの並列処理
- **キャッシュ**: メッセージキャッシュ
- **最適化**: 実行時間の短縮

## 12. 承認・検証

### 12.1 承認基準
- 全機能要件の実装完了
- エラーハンドリングの実装
- テストの通過
- ドキュメントの整備

### 12.2 検証方法
- 手動テスト
- 自動テスト
- ユーザー受け入れテスト
- パフォーマンステスト

---

**作成日**: 2025年9月23日  
**バージョン**: 1.0  
**作成者**: AI Assistant  
**承認者**: [承認者名]
